<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Izinkan Notifikasi</title>
</head>
<body>
    <h2>Izinkan Notifikasi</h2>
    <button onclick="mintaNotifikasi()">Klik untuk Mengizinkan</button>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const redirectUrl = getParameterByName("redirect");

            console.log("Memeriksa status izin notifikasi...");
            console.log("Notification.permission:", Notification.permission);
            console.log("localStorage notif_allowed:", localStorage.getItem("notif_allowed"));

            // Jika notifikasi sudah diizinkan sebelumnya, langsung kembali ke halaman login
            if (Notification.permission === "granted" || localStorage.getItem("notif_allowed") === "true") {
                console.log("Notifikasi sudah diizinkan, kembali ke halaman login...");
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                }
                return; // Stop eksekusi agar tidak lanjut meminta izin
            }
        });

        function getParameterByName(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function mintaNotifikasi() {
            Notification.requestPermission().then(function (permission) {
                console.log("Hasil permintaan izin:", permission);

                if (permission === "granted") {
                    console.log("Izin notifikasi diberikan, menyimpan status...");
                    localStorage.setItem("notif_allowed", "true"); // Simpan izin secara permanen
                    alert("Terima kasih! Anda akan menerima notifikasi.");

                    // Redirect kembali ke halaman login hotspot
                    const redirectUrl = getParameterByName("redirect");
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                    }
                } else {
                    console.log("Izin notifikasi ditolak oleh pengguna.");
                    alert("Anda menolak notifikasi, silakan izinkan di pengaturan browser.");
                }
            });
        }
    </script>
</body>
</html>
